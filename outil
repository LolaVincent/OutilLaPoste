#!/usr/bin/python2.7
# -*- coding: utf-8 -*-
import os
import csv
from PIL import Image # Faire sudo pip install pillow pour utiliser cette librairie
from fpdf import FPDF # Faire sudo pip install fpdf pour utiliser cette librairie
from collections import Counter
import matplotlib.pyplot as plt # pour les graphes, faire sudo apt-get install python-matplotlib avant
import numpy as np


# Problème d'encodage
import sys
reload(sys)
sys.setdefaultencoding('utf8')

""" fonction de lecture du CSV """
def readCSV() :
	nomFichier=raw_input("Veuillez entrer le nom du fichier  que vous voulez analysez (suivi de l'extension ) :")


	with open(nomFichier, 'rb') as csvfile:
		bdd = csv.reader(csvfile, delimiter=';')
		#print bdd.fieldnames


		motif=[]
		sites = {}
		sites['compiegne'] = []
		sites['noyon'] = []
		sites['cuise'] = []
		sites['thourotte'] = []
		sites['venette'] = []
		sites['ressons'] = []
		sites['estrees'] = []
		semaines = []
		
		parcoursBDD(bdd, sites, motif, semaines)
		showMotifGraph(motif)
		showSiteGraph(sites)

def parcoursBDD(bdd, sites, motif, semaines):
	for row in bdd:
		#print(row[13]) #Motifs de reclamation
		if '' != row[13]: # enlever le motif vide
			motif.append(row[13])

		# Séparation des reclamations par site
		for site in sites:
			if str(site) in row[46].lower():
				if '' != row[13]:
					sites[site].append(row[13])
						

""" Calcul du nombre de réclamations par motif et affichage sur un même graphe """
def showMotifGraph (motif):
	

	# Calcul du nombre de reclamation par motifs
	nb_recla_motifs = Counter(motif[1:len(motif)])
	name = nb_recla_motifs.keys()

	data = nb_recla_motifs.values()
	# Construction du camembert

	explode= np.zeros(len(nb_recla_motifs))
	plt.pie(data, explode=explode, labels=name, autopct = lambda x: str(round(x, 1)) + '%', shadow=False)
	plt.axis('equal')
	plt.title('nb_recla_motifs')
	plt.savefig('Graphiques/' + 'nb_recla_motifs.png', fontsize='20')
	plt.show()
	plt.close()

""" Calcul du nombre de réclamations par site et affichage des graphes pour chaque site dans un png
"""

def showSiteGraph(sites) :
	for site in sites:
		sites[site] = Counter(sites[site])
		name = sites[site].keys()
		data = sites[site].values()

		# Construction du camembert

		explode = np.zeros(len(sites[site]))
		plt.pie(data, explode=explode, labels=name, autopct = lambda x: str(round(x, 1)) + '%', 		shadow=False)
 		plt.axis('equal')
		plt.title('Nombre de réclamations par motifs pour '+site)
		plt.savefig('Graphiques/'+site+'.png')
		plt.show()
		plt.close()


""" Fonction pour mettre tous les fichiers d'un répertoire donné dans une liste """
def listeImagesDossier(nomDossier) :
	listeImages=list()
	for element in os.listdir(nomDossier):
		listeImages.append(element)
	return listeImages

"Fonction permettant d'afficher toutes les images dans un pdf"
def fromPNGToPDF(pdfFileName, listImages, dir = ''):

    if (dir):
        dir += "/"

    cover = Image.open(dir + str(listImages[0]) )
    width, height = cover.size

    pdf = FPDF(unit = "pt", format = [width, height])

    for page in listImages:
        pdf.add_page()
        pdf.image(dir + str(page) , 0, 0)

    pdf.output( pdfFileName + ".pdf", "F")


""" FONCTION PRINCIPALE DE NOTRE PROGRAMME """
reponse =readCSV()
question = raw_input("Voulez vous inclure tous les PNG dans un seul dossier PDF ?")
if (question== "oui" or question =="OUI" or question =="O" or question=="o" or question=="oui"):
	fromPNGToPDF("Résumé",listeImagesDossier("Graphiques/"),"Graphiques/")
	print("PDF créé !")
else :
	print ("Rien ne sera effectué.")
print("Fonction finie :) ")
